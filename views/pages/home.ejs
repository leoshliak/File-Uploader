<h1><%= title %></h1>

<% if(locals.user) { %>
  <div class="side">
    <form action="/newFolderHome" method="POST" class="folder-form">
      <div class="input-group">
        <label for="name">Folder Name:</label>
        <input id="name" name="name" placeholder="New Folder" type="text" required />
      </div>
      <button type="submit">Create Folder</button>
    </form>
    <form action="/newFileHome" method="POST" class="file-form" enctype="multipart/form-data">
      <div class="input-group">
        <label for="file">Select File:</label>
        <input id="file" name="file" type="file" required accept="image/*,video/*,application/pdf,.txt,.docx,.zip" />
      </div>
      <button type="submit">Upload File</button>
    </form>
  </div>
  
  <div class="home-container">
    <p>Welcome, <%= user.username %>!</p>

    <% if (locals.folders && folders.length > 0) { %>
      <div class="folders-section">
        <h2>Folders</h2>
        <div class="folders-grid">
          <% folders.forEach(folder => { %>
            <a href="/folder/<%= folder.id  %>" class="folder-item">
              <i class="fas fa-folder"></i>
              <span><%= folder.name %></span>
              <small>
                <%= folder.files ? folder.files.length : 0 %> files
                <%= folder.subfolders ? folder.subfolders.length : 0 %> subfolders
                created at <%= new Date(folder.createdAt).toLocaleDateString() %>
              </small>
              <button class="rename">Rename</button>
              <div class="rename-for" style="display: none;">
                <form action="/folder/<%= folder.id %>/rename" method="POST" class="rename-form">
                  <div class="input-group">
                    <input name="name" type="text" value="<%= folder.name %>" required />
                  </div>
                  <button type="submit"  class="save-folder-change">Save</button>
                  <button type="button" class="cancel-rename">Cancel</button>
                </form>
              </div>
              <form action="/folder/<%= folder.id %>/delete" class="delete-folder" method="POST">
                <button type="submit">Delete</button>
              </form>
            </a>
          <% }) %>
        </div>
      </div>
    <% } %>

    <% if (locals.files && files.length > 0) { %>
      <div class="files-section">
        <h2>Files</h2>
        <div class="files-grid">
          <% files.forEach(file => { %>
            <div class="file-item">
              <i class="fas fa-file"></i>
              <span><%= file.filename %></span>
              <small>
                Uploaded: <%= new Date(file.uploadedAt).toLocaleDateString() %>
              </small>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>

    <% if ((!locals.folders || folders.length === 0) && (!locals.files || files.length === 0)) { %>
      <p class="empty-state">No files or folders yet. Start by creating a folder or uploading a file!</p>
    <% } %>

    <a href="/logout" class="logout-btn">Logout</a>
  </div>
<% } else { %>
  <div class="form-container">
    <h1>Sign In</h1>
    <form action="/login" method="POST">
      <div class="input-group">
        <label for="email">Email:</label>
        <input id="email" name="email" type="email" required />
      </div>

      <div class="input-group">
        <label for="password">Password:</label>
        <input id="password" name="password" type="password" required/>
      </div>
      <button type="submit">Sign In</button>
    </form>

    <a href="/sign-up" class="register-link">Sign Up</a>
  </div>
<% } %>

<script>

  const renameButtons = document.querySelectorAll('.rename');
  const cancelButtons = document.querySelectorAll('.cancel-rename');
  const saveButtons = document.querySelectorAll('.save-folder-change');

  renameButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const renameForm = button.nextElementSibling;
      renameForm.style.display = 'block';
      button.style.display = 'none';
    });
  });

  cancelButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const renameForm = button.closest('.rename-for');
      renameForm.style.display = 'none';
      const renameButton = renameForm.previousElementSibling;
      renameButton.style.display = 'inline-block';
    });
  });

  saveButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      const form = button.closest('form');
      if (form) {
        form.submit();
      }
    });
  });

  document.querySelectorAll('.delete-folder button').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      const form = button.closest('form');
      const folderItem = form.closest('.folder-item');
      const folderName = folderItem.querySelector('span').textContent;
      const filesCount = parseInt(folderItem.querySelector('small').textContent.match(/(\d+) files/)[1]);
      const subfoldersCount = parseInt(folderItem.querySelector('small').textContent.match(/(\d+) subfolders/)[1]);
      
      let message = `Are you sure you want to delete the folder "${folderName}"?`;
      if (filesCount > 0 || subfoldersCount > 0) {
        message += `\nThis folder contains ${filesCount} files and ${subfoldersCount} subfolders. All contents will be permanently deleted!`;
      }
      
      if (confirm(message)) {
        form.submit();
      }
    });
  });

  document.querySelectorAll('.folder-item').forEach(folderItem => {
    folderItem.addEventListener('click', (e) => {
      e.preventDefault();
      if (e.target.tagName.toLowerCase() === 'button' || e.target.closest('.rename-for') || e.target.closest('.delete-folder')) {
        return;
      }
      window.location.href = folderItem.href;
    });
  });
  </script>
