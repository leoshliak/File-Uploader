<div class="folder-con">
    <h1>Folder: <%= folder.name %></h1>

    <form action="/folder/<%= folder.id %>/newFolder" method="POST" class="folder-form">
      <div class="input-group">
        <label for="name">New Subfolder Name:</label>
        <input id="name" name="name" type="text" required />
      </div>
      <button type="submit">Create Subfolder</button>
    </form>

    <form action="/folder/<%= folder.id %>/newFile" method="POST" class="file-form" enctype="multipart/form-data">
      <div class="input-group">
        <label for="file">Select File:</label>
        <input id="file" name="file" type="file" required accept="image/*,video/*,application/pdf,.txt,.docx,.zip" />
      </div>
      <button type="submit">Upload File</button>
    </form>

    <% if (locals.subfolders && subfolders.length > 0) { %>
      <div class="subfolders-section">
        <h2>Subfolders</h2>
        <div class="subfolders-grid">
          <% subfolders.forEach(subfolder => { %>
            <a href="/folder/<%= subfolder.id  %>" class="folder-item">
              <i class="fas fa-folder"></i>
              <span><%= subfolder.name %></span>
              <small>
                <%= subfolder.files ? subfolder.files.length : 0 %> files
                <%= subfolder.subfolders ? subfolder.subfolders.length : 0 %> subfolders
                created at <%= new Date(subfolder.createdAt).toLocaleDateString() %>
              </small>
             <button style="z-index: 99;" class="rename">Rename</button>
              <div class="rename-for" style="display: none;">
                <form action="/folder/<%= subfolder.id %>/rename" method="POST" class="rename-form">
                  <div class="input-group">
                    <input name="name" type="text" value="<%= subfolder.name %>" required />
                  </div>
                  <button type="submit" class="save-folder-change">Save</button>
                  <button type="button" class="cancel-rename">Cancel</button>
                </form>
              </div>
              <form action="/folder/<%= subfolder.id %>/delete" class="delete-folder" method="POST">
                <button type="submit">Delete</button>
              </form>
            </a>
          <% })} %>

          <% if(locals.files && locals.files.length > 0) {%>
            <div class="files-section">
            <h2>Files</h2>
            <div class="files-grid">
            <% files.forEach(file => { %>
              <div class="file-item">
                <i class="fas fa-file"></i>
                <span><%= file.filename %></span>
                <small>
                  Uploaded: <%= new Date(file.uploadedAt).toLocaleDateString() %>
                </small>
              </div>
            <% }) %>
            </div>
            </div>
            <% } %>
        </div>
</div>

<script>

  const renameButtons = document.querySelectorAll('.rename');
  const cancelButtons = document.querySelectorAll('.cancel-rename');
  const saveButtons = document.querySelectorAll('.save-folder-change');

  renameButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const renameForm = button.nextElementSibling;
      renameForm.style.display = 'block';
      button.style.display = 'none';
    });
  });

  cancelButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const renameForm = button.closest('.rename-for');
      renameForm.style.display = 'none';
      const renameButton = renameForm.previousElementSibling;
      renameButton.style.display = 'inline-block';
    });
  });

  saveButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      const form = button.closest('form');
      if (form) {
        form.submit();
      }
    });
  });

  document.querySelectorAll('.delete-folder button').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      const form = button.closest('form');
      const folderItem = form.closest('.folder-item');
      const folderName = folderItem.querySelector('span').textContent;
      const filesCount = parseInt(folderItem.querySelector('small').textContent.match(/(\d+) files/)[1]);
      const subfoldersCount = parseInt(folderItem.querySelector('small').textContent.match(/(\d+) subfolders/)[1]);
      
      let message = `Are you sure you want to delete the folder "${folderName}"?`;
      if (filesCount > 0 || subfoldersCount > 0) {
        message += `\nThis folder contains ${filesCount} files and ${subfoldersCount} subfolders. All contents will be permanently deleted!`;
      }
      
      if (confirm(message)) {
        form.submit();
      }
    });
  });

  document.querySelectorAll('.folder-item').forEach(folderItem => {
    folderItem.addEventListener('click', (e) => {
      e.preventDefault();
      if (e.target.tagName.toLowerCase() === 'button' || e.target.closest('.rename-for') || e.target.closest('.delete-folder')) {
        return;
      }
      window.location.href = folderItem.href;
    });
  });
  </script>